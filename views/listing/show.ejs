<% layout('layouts/boilerplate') -%>
<body>
  <div class="container py-4">
    <h1 class="text-center my-4 fw-bold"><%= listing.title %></h1>

    <div class="card mx-auto shadow-sm border-0 rounded-4" style="max-width: 650px">
      <img
        src="<%= listing.image.url %>"
        class="card-img-top rounded-top-4"
        alt="listing image"
        style="height: 280px; object-fit: cover"
      />

      <div class="card-body px-4">

        <p class="text-muted mb-2">
          <i>Owned by <%= listing.owner.username %></i>
        </p>

        <h5 class="fw-semibold mb-3"><%= listing.description %></h5>

        <p class="card-text mb-3">
          <span class="fw-bold  fs-5">
            ₹ <%= listing.price.toLocaleString('en-IN') %>
          </span><br>

          <span class="fw-semibold">Location:</span>
          <span class="text-secondary"><%= listing.location %></span><br />

          <span class="fw-semibold">Country:</span>
          <span class="text-secondary"><%= listing.country %></span>
        </p>


        <% if (currUser && listing.owner && (typeof listing.owner._id !== 'undefined' ? currUser._id.equals(listing.owner._id) : currUser._id.equals(listing.owner))) { %>
        <div class="d-flex justify-content-between gap-2 mb-4">
          <a href="/listing/<%= listing._id %>/edit" class="btn btn-warning px-4">
            Edit Listing
          </a>
 
          <form action="/listing/<%= listing._id %>?_method=DELETE" method="POST">
            <button type="submit" class="btn btn-danger px-4">
              Delete Listing
            </button>
          </form>
        </div>
        <% } %>
        <hr />

        <h4 class="fw-semibold mt-4">Leave a Review</h4>

        <form action="/listing/<%= listing._id %>/reviews" method="POST" class="mt-3">

          <div class="mb-3">
            <label for="rating" class="form-label fw-semibold">Rating</label>
            <input
              type="range"
              id="rating"
              name="review[rating]"
              min="1"
              max="5"
              required
              class="form-range"
            />
          </div>

          <div class="mb-3">
            <label for="comment" class="form-label fw-semibold">Comment</label>
            <textarea
              id="comment"
              name="review[comment]"
              rows="4"
              class="form-control"
              required
            ></textarea>
            <div class="invalid-feedback">
              Please add some comments for review
            </div>
          </div>

          <button type="submit" class="btn btn-primary px-4">
            Submit Review
          </button>
        </form>

        <hr />

        <h4 class="mt-4 fw-semibold">Customer Reviews</h4>

        <ul class="list-unstyled mt-3">
          <% for (let review of listing.reviews) { %>
          <li class="mb-4 p-3 rounded-3 shadow-sm border">

            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-semibold text-dark"><%= review.author ? review.author.username : 'Anonymous' %></h6>
              <span class="badge bg-success fs-6">
                <%= review.rating %> ★
              </span>
            </div>

            <hr class="my-2" />

            <p class="mb-2 text-secondary">
              <%= review.comment %>
            </p>

            <% if (currUser && review.author && review.author._id.equals(currUser._id)) { %>
            <form method="POST"
              action="/listing/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              class="mt-2">
              <button class="btn btn-outline-danger btn-sm">
                Delete
              </button>
            </form>
            <% } %>

          </li>
          <% } %>
        </ul>

      </div>
    </div>
  </div>
</body>